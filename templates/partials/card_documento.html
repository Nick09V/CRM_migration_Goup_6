{% with doc=req.obtener_documento_actual %}
<div id="card-req-{{ req.id }}" 
     {% if oob_swap %}hx-swap-oob="true"{% endif %}
     class="rounded-xl border p-5 flex flex-col justify-between h-full transition-all duration-300 shadow-sm relative overflow-hidden
     {% if req.estado == 'revisado' %}
        bg-emerald-50 border-emerald-200
     {% elif doc and doc.estado == 'pendiente' %}
        bg-white border-blue-200 ring-1 ring-blue-100
     {% elif req.estado == 'faltante' and req.observaciones %}
        bg-rose-50 border-rose-200
     {% else %}
        bg-white border-slate-200 hover:border-slate-300
     {% endif %}">

    <div class="absolute top-4 right-4">
        {% if req.estado == 'revisado' %}
            <span class="flex h-3 w-3 relative">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
            </span>
        {% elif doc and doc.estado == 'pendiente' %}
            <span class="flex h-3 w-3 relative">
                <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-400"></span>
            </span>
        {% elif req.estado == 'faltante' and req.observaciones %}
             <span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
        {% else %}
             <span class="relative inline-flex rounded-full h-2 w-2 bg-slate-300"></span>
        {% endif %}
    </div>

    <div class="mb-4 pr-6">
        <div class="inline-flex p-2 rounded-lg mb-3
            {% if req.estado == 'revisado' %}bg-emerald-100 text-emerald-600
            {% elif doc and doc.estado == 'pendiente' %}bg-blue-50 text-blue-600
            {% elif req.estado == 'faltante' and req.observaciones %}bg-rose-100 text-rose-600
            {% else %}bg-slate-100 text-slate-500{% endif %}">
            <span class="material-symbols-outlined text-xl">
                {% if req.estado == 'revisado' %}check_circle
                {% elif req.estado == 'faltante' and req.observaciones %}gavel
                {% else %}description{% endif %}
            </span>
        </div>
        
        <h4 class="font-bold text-slate-800 text-sm leading-tight">{{ req.nombre }}</h4>
    </div>

    <div class="mb-4 flex-1">
        {% if doc %}
            <div class="text-[10px] text-slate-500 space-y-1">
                <p class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-[12px]">calendar_today</span>
                    Subido: {{ doc.creado_en|date:"d M, H:i" }}
                </p>
                <p class="font-mono text-slate-400">{{ doc.archivo.size|filesizeformat }}</p>
            </div>

            <div class="mt-3 flex items-center gap-4 border-t border-slate-100/50 pt-2">
                <a href="{{ doc.archivo.url }}" target="_blank"
                   class="inline-flex items-center gap-1 text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline">
                   <span class="material-symbols-outlined text-sm">visibility</span>
                   Ver
                </a>

                <button 
                   hx-get="{% url 'historial_versiones' req.id %}"
                   hx-target="#contenedor-drawer"
                   hx-swap="innerHTML"
                   class="inline-flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-primary hover:underline transition-colors cursor-pointer"
                   title="Ver versiones anteriores">
                   <span class="material-symbols-outlined text-sm">history</span>
                   Historial
                </button>
            </div>

            {% if req.estado == 'faltante' and req.observaciones %}
                <div class="mt-3 p-2 bg-rose-100/50 rounded text-[10px] text-rose-700 border border-rose-200">
                    <strong class="block mb-0.5">Motivo del rechazo:</strong> 
                    {{ req.observaciones }}
                </div>
            {% endif %}

        {% else %}
            <div class="h-full flex flex-col justify-center">
                <p class="text-xs text-slate-400 italic flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">upload_file</span>
                    Pendiente de subida...
                </p>
            </div>
        {% endif %}
    </div>

    <div class="mt-auto pt-3 border-t border-slate-100">
        {% if req.estado == 'revisado' %}
            <div class="w-full py-2 bg-emerald-50/50 text-emerald-600 text-xs font-bold rounded-lg flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-sm">verified</span>
                Validado
                <button onclick="abrirModalRechazo('{{ req.id }}')" 
                        class="ml-2 text-[10px] text-slate-400 underline hover:text-rose-500 font-normal">
                    (Cambiar)
                </button>
            </div>

        {% elif doc %}
            {% if req.estado != 'faltante' or not req.observaciones %}
                <div class="grid grid-cols-2 gap-2">
                    <button 
                        hx-post="{% url 'aprobar_documento' req.id %}"
                        hx-target="#card-req-{{ req.id }}"
                        hx-swap="outerHTML"
                        class="py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold rounded-lg shadow-sm shadow-emerald-200 transition-transform active:scale-95 flex items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-sm">check</span> Aprobar
                    </button>
                    
                    <button 
                        onclick="abrirModalRechazo('{{ req.id }}')"
                        class="py-2 bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold rounded-lg shadow-sm shadow-rose-200 transition-transform active:scale-95 flex items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-sm">close</span> Rechazar
                    </button>
                </div>
            {% else %}
                <div class="w-full py-2 bg-rose-50 text-rose-600 text-xs font-bold rounded-lg flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">block</span>
                    Rechazado
                </div>
            {% endif %}

        {% else %}
            <div class="w-full py-2 text-center text-[10px] text-slate-300 font-bold uppercase tracking-wider">
                Esperando Cliente
            </div>
        {% endif %}
    </div>
</div>
{% endwith %}